apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "wordpress.fullname" . }}-nginx-config
  labels:
    {{- include "wordpress.labels" . | nindent 4 }}
data:
  nginx.conf: |
    user nginx;
    worker_processes auto;
    pid /var/run/nginx.pid;

    events {
        worker_connections 2048;
        multi_accept on;
        use epoll;
    }

    http {
        # Basic Settings
        sendfile on;
        tcp_nopush on;
        tcp_nodelay on;
        keepalive_timeout 65;
        types_hash_max_size 2048;
        server_tokens off;

        include /etc/nginx/mime.types;
        default_type application/octet-stream;

        # HTTPS detection for reverse proxy
        map $http_x_forwarded_proto $fastcgi_https {
            default '';
            https 'on';
        }

        # Logging
        access_log /var/log/nginx/access.log;
        error_log /var/log/nginx/error.log warn;

        # Gzip Compression
        gzip on;
        gzip_vary on;
        gzip_proxied any;
        gzip_comp_level 6;
        gzip_types text/plain text/css text/xml text/javascript
                   application/json application/javascript application/xml+rss
                   application/rss+xml font/truetype font/opentype
                   application/vnd.ms-fontobject image/svg+xml;
        gzip_disable "msie6";

        # File Upload Size
        client_max_body_size {{ .Values.wordpress.maxUploadSize | default "64M" }};
        client_body_buffer_size 128k;

        # FastCGI Cache (optional, disabled by default)
        {{- if .Values.wordpress.nginx.fastcgiCache.enabled }}
        fastcgi_cache_path /var/cache/nginx levels=1:2 keys_zone=WORDPRESS:100m inactive=60m;
        fastcgi_cache_key "$scheme$request_method$host$request_uri";
        {{- end }}

        upstream php-fpm {
            server 127.0.0.1:9000;
        }

        server {
            listen 80;
            server_name _;

            root /var/www/html;
            index index.php index.html;

            # Security Headers
            add_header X-Frame-Options "SAMEORIGIN" always;
            add_header X-Content-Type-Options "nosniff" always;
            add_header X-XSS-Protection "1; mode=block" always;

            # Real IP from Ingress
            set_real_ip_from 10.0.0.0/8;
            set_real_ip_from 172.16.0.0/12;
            set_real_ip_from 192.168.0.0/16;
            real_ip_header X-Forwarded-For;
            real_ip_recursive on;

            # Deny access to sensitive files
            location ~* /(?:\.(?!well-known)|wp-config\.php|readme\.html|license\.txt) {
                deny all;
            }

            # Static files - must be before location /, regex location has higher priority
            location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|webp|mp4|webm|ogg|mp3|wav|flv|swf|zip|tar|gz|bz2|rar|pdf|doc|docx|xls|xlsx|ppt|pptx|txt)$ {
                root /var/www/html;
                expires 30d;
                add_header Cache-Control "public, immutable";
                access_log /var/log/nginx/static-access.log;
                error_log /var/log/nginx/static-error.log;
            }

            # WordPress specific locations
            location / {
                try_files $uri $uri/ /index.php?$args;
            }

            # PHP-FPM handler
            location ~ \.php$ {
                try_files $uri =404;
                fastcgi_split_path_info ^(.+\.php)(/.+)$;
                fastcgi_pass php-fpm;
                fastcgi_index index.php;

                include /etc/nginx/fastcgi_params;
                fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
                fastcgi_param PATH_INFO $fastcgi_path_info;

                # HTTPS detection for reverse proxy
                fastcgi_param HTTPS $fastcgi_https;

                # FastCGI settings
                fastcgi_connect_timeout 60;
                fastcgi_send_timeout 180;
                fastcgi_read_timeout 180;
                fastcgi_buffer_size 128k;
                fastcgi_buffers 4 256k;
                fastcgi_busy_buffers_size 256k;
                fastcgi_temp_file_write_size 256k;
                fastcgi_intercept_errors on;

                {{- if .Values.wordpress.nginx.fastcgiCache.enabled }}
                # FastCGI Cache
                fastcgi_cache WORDPRESS;
                fastcgi_cache_valid 200 60m;
                fastcgi_cache_bypass $no_cache;
                fastcgi_no_cache $no_cache;
                add_header X-Cache-Status $upstream_cache_status;
                {{- end }}
            }

            # Deny access to uploads PHP files
            location ~* /(?:uploads|files)/.*\.php$ {
                deny all;
            }

            # WordPress admin: don't cache
            location ~* /wp-admin {
                try_files $uri $uri/ /index.php?$args;
            }
        }
    }